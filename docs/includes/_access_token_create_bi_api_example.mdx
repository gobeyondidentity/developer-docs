import MultiLanguageCodeBlock from '/src/components/CodeBlocks/MultiLanguageCodeBlock';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

To request tokens for the Beyond Identity Management API programmatically, we recommend that you create an app that references the 'Beyond Identity Management API' Resource Server, then send a request to the app's `/authorize` and/or `/token` API endpoints following the [OAuth and OIDC protocols](/docs/create-api-token#api).

Follow the steps below based on the flow you wish to use, either client credentials or authorization code:

<Tabs>
<TabItem value="client-credentials" label="Client Credentials">

1. Create an [app](/docs/add-an-application) with the following properties:

  | Property | Value |
  | --- | --- |
  | **Protocol** | OAuth2 |
  | **Client Type** | Confidential |
  | **PKCE** | Disabled |
  | **Token Endpoint Auth Method** | Client Secret Basic |
  | **Grant Type** | Client Credentials |
  | **Resource Server** | Beyond Identity Management API |
  | **Allowed Scopes** | add the scopes required for the API call based on the [Beyond Identity Management API documentation](https://developer.beyondidentity.com/api/v1) |

2. Fill in a **Display Name**, then click **Submit** to save the app.

3. Next, create the `/token` request as shown below:

  <MultiLanguageCodeBlock
  curl='curl "https://auth-$(us|eu).beyondidentity.com/v1/tenants/$(tenant_id)/realms/$(realm_id)/applications/$(application_id)/token" \
  -X POST \
  -u "$(client_id):$(client_secret)" --basic \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials&scope=$(scope)"'
  title="/token"
  />

  where:

    - application_id is the **Application ID** of the app you created

    - client_id and client_secret are the **Client ID** and **Client Secret**, respectively, of the app you created

    - scopes is one or more of the app's **Allowed Scopes**, space delimited, and includes the required scopes for the API call(s) your app will make

</TabItem>
<TabItem value="authorization-code" label="Authorization Code">

  1. Create an [app](/docs/add-an-application) with the following properties:

    | Property | Value |
    | --- | --- |
    | **Protocol** | OIDC |
    | **Client Type** | Confidential |
    | **PKCE** | S256 |
    | **Token Endpoint Auth Method** | Client Secret Basic |
    | **Grant Type** | Authorization Code |
    | **Resource Server** | Beyond Identity Management API |
    | **Allowed Scopes** | add the scopes required for the API call based on the [Beyond Identity Management API documentation](https://developer.beyondidentity.com/api/v1) |
    | **Configuration Type (on Authenticator Config tab)** | Hosted Web |

  2. Fill in a **Display Name** and at least one **Redirect URI**, then click **Submit** to save the app.

  3. Next, use the following examples to obtain an authorization code and then to create a token with that code:

    Create the `/authorize` call to obtain an authorization code:

    <MultiLanguageCodeBlock
    curl='curl -G "https://auth-{us|eu}.beyondidentity.com/v1/tenants/{tenant_id}/realms/{realm_id}/applications/{application_id}/authorize" \
    --data-urlencode "response_type=code" \
    --data-urlencode "client_id=$(client_id)" \
    --data-urlencode "redirect_uri=$(redirect_uri)" \
    --data-urlencode "scope=$(scopes)" \
    --data-urlencode "state=$(state)" \
    --data-urlencode "code_challenge=$(codeChallenge)" \
    --data-urlencode "code_challenge_method=S256"'
    title="/authorize"
    />

    where:

      - application_id is the **Application ID** of the app you created

      - client_id is your app's **Client ID**

      - redirect_uri is one of the app's configured **Redirect URI** values

      - scopes is 'openid' plus one or more of the app's **Allowed Scopes**, space delimited

      - state is a value generated by your app to maintain state betewen the request and response

      - codeChallenge is generated as defined in [RFC 7636](https://datatracker.ietf.org/doc/html/rfc7636#section-4.2), example JavaScript snippet below:

    ```javascript
    codeVerifier = crypto.randomBytes(32).toString("base64url");
    codeChallenge = crypto
      .createHash("sha256")
      .update(codeVerifier)
      .digest()
      .toString("base64url");
    ```

    Then create the`/token` call to create an access token:

    <MultiLanguageCodeBlock
      curl='curl "https://auth-{us|eu}.beyondidentity.com/v1/tenants/{tenant_id}/realms/{realm_id}/applications/{application_id}/token" \
      -X POST \
      -u "$(client_id):$(client_secret)" --basic \
      -H "Content-Type: application/x-www-form-urlencoded" \
      -d "grant_type=authorization_code&code=$(authorization_code)&redirect_uri=${redirect_uri}&client_id=$(client_id)&code_verifier=$(CODE_VERIFIER)"'
      title="/token"
    />

    where:

      - application_id is the **Application ID** of the app you created

      - client_id and client_secret are the **Client ID** and **Client Secret**, respectively, of the app you created

      - redirect_uri is one of the app's configured **Redirect URI** values and matches the redirect_uri sent in the `/authorize` call

      - authorization_code is the code returned from the `/authorize` call

      - codeVerifier is defined as in [RFC 7636](https://datatracker.ietf.org/doc/html/rfc7636#section-4.1), example JavaScript snippet below:

    ```javascript
    codeVerifier = crypto.randomBytes(32).toString("base64url");
    codeChallenge = crypto
      .createHash("sha256")
      .update(codeVerifier)
      .digest()
      .toString("base64url");
    ```

</TabItem>
</Tabs>
